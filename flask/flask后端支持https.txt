
# åœºæ™¯ï¼š
A æœºå™¨ï¼ˆ192.168.3.105ï¼‰ï¼šç»Ÿä¸€ç”Ÿæˆè¯ä¹¦
B æœºå™¨ï¼ˆ192.168.3.106ï¼‰ å’Œ C æœºå™¨ï¼ˆ192.168.3.107ï¼‰ï¼šå„è‡ªéƒ¨ç½² HTTPS æœåŠ¡ï¼ˆä½¿ç”¨åŒä¸€å¥—è¯ä¹¦ï¼‰
Dã€E æœºå™¨ï¼šè®¿é—® B æˆ– C çš„ HTTPS æœåŠ¡

ç¬¬ä¸€æ­¥ï¼šåœ¨ A æœºå™¨ç”Ÿæˆå¤š IP æ”¯æŒçš„è¯ä¹¦ï¼ˆå…³é”®ï¼ï¼‰
ğŸ“ A æœºå™¨ IPï¼š192.168.3.105ï¼ˆä»…ç”¨äºç”Ÿæˆï¼Œä¸å‚ä¸æœåŠ¡ï¼‰
bash
# åˆ›å»º SAN é…ç½®æ–‡ä»¶ï¼ˆåŒ…å« B å’Œ C çš„ IPï¼‰
cat > san.cnf <<EOF
[req]
default_bits = 4096
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = v3_req

[dn]
CN = selection-service.local  # å¯ä»»æ„å‘½å

[v3_req]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[alt_names]
IP.1 = 192.168.3.106   # â† B æœºå™¨çš„ IP
IP.2 = 192.168.3.107   # â† C æœºå™¨çš„ IP
DNS.1 = localhost
IP.3 = 127.0.0.1
EOF

# ç”Ÿæˆè¯ä¹¦å’Œç§é’¥
openssl req -x509 -newkey rsa:4096 -nodes -keyout key.pem -out cert.pem -days 365 -config san.cnf -extensions v3_req

# éªŒè¯æ˜¯å¦åŒ…å«ä¸¤ä¸ª IP
openssl x509 -in cert.pem -text -noout | grep -A2 "Subject Alternative Name"
âœ… è¾“å‡ºåº”åŒ…å«ï¼š
IP Address:192.168.3.106, IP Address:192.168.3.107, DNS:localhost, IP Address:127.0.0.1
ğŸ”’ è¿™å¥— cert.pem + key.pem ç°åœ¨å¯ä»¥åŒæ—¶ç”¨äº B å’Œ C æœºå™¨

ç¬¬äºŒæ­¥ï¼šå°†è¯ä¹¦å¤åˆ¶åˆ° B å’Œ C æœºå™¨
ğŸ“ B æœºå™¨ IPï¼š192.168.3.106
ğŸ“ C æœºå™¨ IPï¼š192.168.3.107
åœ¨ A æœºå™¨æ‰§è¡Œï¼š
# å¤åˆ¶åˆ° B
scp cert.pem key.pem user@192.168.3.106:/home/user/selection-demo/

# å¤åˆ¶åˆ° C
scp cert.pem key.pem user@192.168.3.107:/home/user/selection-demo/
ğŸ’¡ ä¸¤å°æœºå™¨ç”¨å®Œå…¨ç›¸åŒçš„è¯ä¹¦æ–‡ä»¶

ç¬¬ä¸‰æ­¥ï¼šåœ¨ B å’Œ C åˆ†åˆ«éƒ¨ç½² Flask HTTPS æœåŠ¡
åœ¨ B æœºå™¨ï¼ˆ192.168.3.106ï¼‰æ“ä½œï¼š
cd ~/selection-demo
pip install flask flask-cors

# åˆ›å»º app.pyï¼ˆå†…å®¹è§ä¸‹æ–¹ï¼‰
python app.py  # å¯åŠ¨æœåŠ¡
åœ¨ C æœºå™¨ï¼ˆ192.168.3.107ï¼‰æ“ä½œï¼š
åŒæ ·æ­¥éª¤ï¼Œä»£ç å®Œå…¨ä¸€è‡´ã€‚

ç¬¬å››æ­¥ï¼šFlask æœåŠ¡ä»£ç ï¼ˆB å’Œ C å…±ç”¨ï¼‰
app.pyï¼ˆæ”¾åœ¨ B å’Œ C çš„ /home/user/selection-demo/ ç›®å½•ä¸‹ï¼‰

from flask import Flask, request, jsonify
import socket

app = Flask(__name__)

@app.route('/health')
def health():
    host_ip = socket.gethostbyname(socket.gethostname())
    return f"âœ… HTTPS æœåŠ¡è¿è¡Œä¸­ï¼æœ¬æœº IP: {host_ip}"

@app.route('/api/submit-selection', methods=['POST'])
def handle_selection():
    data = request.get_json() or {}
    include = data.get('include', [])
    exclude = data.get('exclude', [])
    print(f"[{socket.gethostbyname(socket.gethostname())}] æ”¶åˆ°æ•°æ®ï¼š{len(include)} åŒ…å«, {len(exclude)} æ’é™¤")
    return jsonify({
        "status": "success",
        "server_ip": socket.gethostbyname(socket.gethostname()),
        "received": {"include": include, "exclude": exclude}
    })

if __name__ == '__main__':
    # ç»‘å®šæ‰€æœ‰æ¥å£ï¼Œå…è®¸å¤–éƒ¨è®¿é—®
    app.run(host='0.0.0.0', port=5000, ssl_context=('cert.pem', 'key.pem'))
ğŸŸ¢ ä¸¤å°æœºå™¨å¯åŠ¨åï¼š

B æä¾›ï¼šhttps://192.168.3.106:5000
C æä¾›ï¼šhttps://192.168.3.107:5000
ç¬¬äº”æ­¥ï¼šåœ¨ D / E æœºå™¨è®¿é—®æœåŠ¡
ğŸ“ Dã€E æœºå™¨ï¼šä»»æ„å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ã€curlã€Pythonï¼‰
æ–¹å¼ 1ï¼šä¸´æ—¶è·³è¿‡éªŒè¯ï¼ˆæµ‹è¯•ç”¨ï¼‰

# è®¿é—® B
curl -k https://192.168.3.106:5000/health

# è®¿é—® C
curl -k https://192.168.3.107:5000/health
æ–¹å¼ 2ï¼šæ¨èï¼ å°†è¯ä¹¦å¯¼å…¥ä¿¡ä»»åº“ï¼ˆæ°¸ä¹…è§£å†³è­¦å‘Šï¼‰
åœ¨ D / E æœºå™¨æ‰§è¡Œï¼š

# ä» A/B/C è·å– cert.pemï¼ˆä»»é€‰å…¶ä¸€ï¼‰
scp user@192.168.3.105:/path/to/cert.pem ./selection-ca.pem

# Linux å®‰è£…åˆ°ç³»ç»Ÿä¿¡ä»»åº“
sudo cp selection-ca.pem /usr/local/share/ca-certificates/selection-ca.crt
sudo update-ca-certificates

# Windows/macOSï¼šåŒå‡» .pem æ–‡ä»¶ â†’ å¯¼å…¥åˆ°â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€
ä¹‹åæµè§ˆå™¨è®¿é—® https://192.168.3.106:5000 å’Œ https://192.168.3.107:5000 ä¸å†æœ‰å®‰å…¨è­¦å‘Šã€‚

ğŸ”’ å®‰å…¨ä¸ç½‘ç»œæ³¨æ„äº‹é¡¹
é¡¹ç›®	è¯´æ˜
é˜²ç«å¢™	B/C æœºå™¨éœ€å¼€æ”¾ 5000 ç«¯å£ï¼š
sudo ufw allow 5000/tcp
ç§é’¥ä¿æŠ¤	key.pem æƒé™è®¾ä¸º 600ï¼š
chmod 600 key.pem
è¯ä¹¦å¤ç”¨é£é™©	å¤šå°æœºå™¨å…±ç”¨ç§é’¥ï¼Œä¸€æ—¦ä¸€å°æ³„éœ²ï¼Œå…¨éƒ¨å—å½±å“
âœ… ç”Ÿäº§ç¯å¢ƒå»ºè®®æ¯å°æœºå™¨ç‹¬ç«‹è¯ä¹¦
IP å˜æ›´	è‹¥ B/C IP æ”¹å˜ï¼Œéœ€é‡æ–°ç”Ÿæˆè¯ä¹¦ï¼ˆå›  SAN å†™æ­» IPï¼‰
âœ… æœ€ç»ˆæ¶æ„å›¾

A (192.168.3.105) â€”â€” ç”Ÿæˆè¯ä¹¦ â€”â€”â†’ [cert.pem + key.pem]
                             â”‚
                             â†“
B (192.168.3.106) â†â”€ å¤åˆ¶è¯ä¹¦ â”€â”€ å¯åŠ¨ Flask HTTPS â†’ D/E å¯è®¿é—® https://192.168.3.106:5000
                             â”‚
                             â†“
C (192.168.3.107) â†â”€ å¤åˆ¶è¯ä¹¦ â”€â”€ å¯åŠ¨ Flask HTTPS â†’ D/E å¯è®¿é—® https://192.168.3.107:5000
ğŸ§ª éªŒè¯å‘½ä»¤ï¼ˆåœ¨ D æˆ– E æœºå™¨ï¼‰

# æµ‹è¯• B
curl -k https://192.168.3.106:5000/health
# åº”è¿”å›ï¼šâœ… HTTPS æœåŠ¡è¿è¡Œä¸­ï¼æœ¬æœº IP: 192.168.3.106

# æµ‹è¯• C
curl -k https://192.168.3.107:5000/health
# åº”è¿”å›ï¼šâœ… HTTPS æœåŠ¡è¿è¡Œä¸­ï¼æœ¬æœº IP: 192.168.3.107
ğŸ’¡ æ€»ç»“
å…³é”®ç‚¹ï¼šè¯ä¹¦çš„ SAN å¿…é¡»åŒ…å«æ‰€æœ‰è¦æä¾›æœåŠ¡çš„æœºå™¨ IPï¼ˆB å’Œ Cï¼‰
æ“ä½œæ ¸å¿ƒï¼šä¸€å¥—è¯ä¹¦å¤åˆ¶åˆ°å¤šå°æœåŠ¡å™¨ï¼Œå‰ææ˜¯å®ƒä»¬éƒ½åœ¨ SAN åˆ—è¡¨ä¸­
å®¢æˆ·ç«¯ä½“éªŒï¼šå¯¼å…¥ä¸€æ¬¡æ ¹è¯ä¹¦ï¼Œå³å¯ä¿¡ä»»æ‰€æœ‰æœåŠ¡èŠ‚ç‚¹
è¿™æ ·å°±å®ç°äº†â€œä¸€è¯å¤šç”¨â€çš„å†…ç½‘ HTTPS æœåŠ¡æ¶æ„ï¼Œéå¸¸é€‚åˆå¼€å‘æ¼”ç¤ºã€æµ‹è¯•ç¯å¢ƒæˆ–å°å‹å†…ç½‘ç³»ç»Ÿã€‚


